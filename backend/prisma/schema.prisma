generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User (pour l'instant un seul user en dur)
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  notes   Note[]
  reviews Review[]

  @@map("users")
}

// Note avec contenu JSONB
model Note {
  id        String   @id @default(uuid())
  title     String
  content   Json     @db.JsonB
  source    String?
  isMOC     Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  linksTo    NoteLink[] @relation("NoteLinksTo")
  linkedFrom NoteLink[] @relation("NoteLinkedFrom")

  mocNotes NoteMOC[] @relation("MOCContainsNotes")
  inMOCs   NoteMOC[] @relation("NoteInMOCs")

  review Review?

  @@index([userId])
  @@index([createdAt])
  @@index([isMOC])
  @@map("notes")
}

// Table de jointure pour les liens [[note]]
model NoteLink {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  sourceId String
  source   Note   @relation("NoteLinksTo", fields: [sourceId], references: [id], onDelete: Cascade)

  targetId String
  target   Note   @relation("NoteLinkedFrom", fields: [targetId], references: [id], onDelete: Cascade)

  @@unique([sourceId, targetId])
  @@index([sourceId])
  @@index([targetId])
  @@map("note_links")
}

// Table de jointure pour les MOCs (Many-to-Many)
model NoteMOC {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  mocId String
  moc   Note   @relation("MOCContainsNotes", fields: [mocId], references: [id], onDelete: Cascade)

  noteId String
  note   Note   @relation("NoteInMOCs", fields: [noteId], references: [id], onDelete: Cascade)

  @@unique([mocId, noteId])
  @@index([mocId])
  @@index([noteId])
  @@map("note_mocs")
}

// ✅ NOUVEAU : Review pour répétition espacée (SM-2)
model Review {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  noteId String @unique
  note   Note   @relation(fields: [noteId], references: [id], onDelete: Cascade)
  
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Paramètres SM-2
  easiness    Float    @default(2.5)  // Facteur E (1.3 à 2.5)
  interval    Int      @default(0)    // Jours avant prochaine révision
  repetitions Int      @default(0)    // Nombre de révisions réussies
  nextReview  DateTime                // Date de la prochaine révision

  // Historique
  lastQuality Int?      // Dernière note (0-5)
  lastReview  DateTime? // Dernière révision effectuée

  @@index([userId, nextReview])
  @@map("reviews")
}