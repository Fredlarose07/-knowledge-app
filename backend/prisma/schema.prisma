generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User (pour l'instant un seul user en dur)
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  notes Note[]

  @@map("users")
}

// Note avec contenu JSONB
model Note {
  id        String   @id @default(uuid())
  title     String
  content   Json     @db.JsonB // Format Novel/Tiptap
  source    String? // Source optionnelle
  isMOC     Boolean  @default(false) // TRUE si c'est un MOC (Map of Content)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Liens bidirectionnels entre notes
  linksTo    NoteLink[] @relation("NoteLinksTo")
  linkedFrom NoteLink[] @relation("NoteLinkedFrom")

  // Relations MOC (Many-to-Many)
  // Si cette note est un MOC, elle contient des notes via mocNotes
  mocNotes NoteMOC[] @relation("MOCContainsNotes")
  // Cette note peut être dans plusieurs MOCs via inMOCs
  inMOCs   NoteMOC[] @relation("NoteInMOCs")

  @@index([userId])
  @@index([createdAt])
  @@index([isMOC]) // Index pour filtrer les MOCs rapidement
  @@map("notes")
}

// Table de jointure pour les liens [[note]]
model NoteLink {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  // Note source (celle qui contient le lien)
  sourceId String
  source   Note   @relation("NoteLinksTo", fields: [sourceId], references: [id], onDelete: Cascade)

  // Note cible (celle qui est référencée)
  targetId String
  target   Note   @relation("NoteLinkedFrom", fields: [targetId], references: [id], onDelete: Cascade)

  @@unique([sourceId, targetId]) // Éviter les doublons
  @@index([sourceId])
  @@index([targetId])
  @@map("note_links")
}

// Table de jointure pour les MOCs (Many-to-Many)
model NoteMOC {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  // Note qui est un MOC (isMOC = true)
  mocId String
  moc   Note   @relation("MOCContainsNotes", fields: [mocId], references: [id], onDelete: Cascade)

  // Note contenue dans le MOC
  noteId String
  note   Note   @relation("NoteInMOCs", fields: [noteId], references: [id], onDelete: Cascade)

  @@unique([mocId, noteId]) // Éviter les doublons
  @@index([mocId])
  @@index([noteId])
  @@map("note_mocs")
}